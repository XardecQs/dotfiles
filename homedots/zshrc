#!/usr/bin/env zsh
# Optimized ZSH configuration for NixOS
# Last updated: 2026-02-11

#──────────────────── P10k Instant Prompt ────────────────────#
# Enable Powerlevel10k instant prompt for faster startup
[[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]] && \
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"

#──────────────────── Zinit Plugin Manager ────────────────────#
ZINIT_HOME="${XDG_DATA_HOME:-$HOME/.local/share}/zinit/zinit.git"
if [[ ! -d "$ZINIT_HOME" ]]; then
  mkdir -p "$(dirname $ZINIT_HOME)"
  git clone https://github.com/zdharma-continuum/zinit.git "$ZINIT_HOME"
fi
source "${ZINIT_HOME}/zinit.zsh"

#──────────────────── Core Shell Settings ────────────────────#
export EDITOR=nvim
export VISUAL=nvim
export PAGER=less

#──────────────────── History Configuration ────────────────────#
HISTSIZE=100000
SAVEHIST=100000
HISTFILE="${XDG_DATA_HOME:-$HOME/.local/share}/zsh/history"
mkdir -p "$(dirname "$HISTFILE")"

setopt extended_history hist_expire_dups_first hist_ignore_dups \
       hist_ignore_space hist_verify share_history inc_append_history

#──────────────────── Completion System ────────────────────#
autoload -Uz compinit colors select-word-style
compinit -d "${XDG_CACHE_HOME:-$HOME/.cache}/zsh/zcompdump"
colors
select-word-style bash

zinit cdreplay -q
zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}'
zstyle ':completion:*' menu select
zstyle ':completion:*' list-colors "${(s.:.)LS_COLORS}"
zstyle ':completion:*' group-name ''
zstyle ':completion:*:descriptions' format '%F{blue}-- %d --%f'

# FZF tab preview
zstyle ':fzf-tab:*' fzf-flags --height=55% --border
zstyle ':fzf-tab:complete:cd:*' fzf-preview \
  'lsd --color=always --tree --depth 2 $realpath 2>/dev/null || ls --color=always $realpath'

#──────────────────── Key Bindings ────────────────────#
bindkey '^[[1;5C' forward-word      # Ctrl+Right
bindkey '^[[1;5D' backward-word     # Ctrl+Left
bindkey '^H' backward-kill-word     # Ctrl+Backspace
bindkey '^[[3~' delete-char         # Delete
bindkey '^[[3;5~' kill-word         # Ctrl+Delete
bindkey '^[[1~' beginning-of-line   # Home
bindkey '^[[4~' end-of-line         # End

#──────────────────── Tool Integrations ────────────────────#
(( $+commands[fzf] )) && eval "$(fzf --zsh)"
(( $+commands[zoxide] )) && eval "$(zoxide init --cmd cd zsh)"
(( $+commands[direnv] )) && eval "$(direnv hook zsh)"

#──────────────────── Plugins ────────────────────#
zinit light zsh-users/zsh-syntax-highlighting
zinit light zsh-users/zsh-autosuggestions
zinit light zsh-users/zsh-completions
zinit light Aloxaf/fzf-tab
zinit light nix-community/nix-zsh-completions

#──────────────────── Aliases ────────────────────#
# Core utilities
alias ls='lsd' ll='lsd -lh' la='lsd -a' lla='lsd -la' lt='lsd --tree'
alias cat='bat --style=plain'
alias grep='grep --color=auto' diff='diff --color=auto'
alias cp='cp --reflink=auto -v' mv='mv -v' rm='rm -v'

# Navigation
alias ..='cd ..' ...='cd ../..' ....='cd ../../..' ~='cd ~'

# Quick commands
alias c='clear' q='exit' :q='exit' h='history' j='jobs -l'
alias vim='nvim' snvim='sudo -E nvim'

# Git shortcuts
alias g='git' ga='git add' gp='git pull' gc='git commit' \
      gs='git status' gl='git log --oneline --graph' gd='git diff'

# NixOS management
alias update='sudo nixos-rebuild switch --flake /etc/nixos'
alias test-update='sudo nixos-rebuild test --flake /etc/nixos'
alias cleanup='sudo nix-collect-garbage -d'
alias nix-shell='nix-shell --run zsh'
alias nix-search='nix search nixpkgs'

# Dotfiles management
alias dots='cd ~/.dotfiles'
alias dotsn='cd ~/.dotfiles && nvim'
alias dotsc='cd ~/.dotfiles && code .'

# Conditional tool aliases
(( $+commands[code] )) && alias codepwd='code "$(pwd)"'
(( $+commands[nautilus] )) && alias napwd='nautilus "$(pwd)" 2>/dev/null & disown'
(( $+commands[dolphin] )) && alias dopwd='dolphin "$(pwd)" 2>/dev/null & disown'
(( $+commands[fastfetch] )) && alias cf='clear && fastfetch'
(( $+commands[unimatrix] )) && alias umatrix='unimatrix -s 95 -f'

#──────────────────── Functions ────────────────────#
# Create directory and cd into it
mkcd() { mkdir -p "$1" && cd "$1"; }

# Extract various archive formats
extract() {
  [[ ! -f "$1" ]] && echo "'$1' is not a valid file" && return 1
  case $1 in
    *.tar.bz2|*.tbz2) tar xjf "$1" ;;
    *.tar.gz|*.tgz) tar xzf "$1" ;;
    *.tar.xz) tar xf "$1" ;;
    *.tar) tar xf "$1" ;;
    *.bz2) bunzip2 "$1" ;;
    *.gz) gunzip "$1" ;;
    *.rar) unrar x "$1" ;;
    *.zip) unzip "$1" ;;
    *.Z) uncompress "$1" ;;
    *.7z) 7z x "$1" ;;
    *) echo "'$1' cannot be extracted" ;;
  esac
}

# Quick backup
backup() { cp -r "$1" "$1.bak"; }

# NixOS specific: rebuild and switch with automatic sudo
rebuild() {
  local flake_path="${1:-/etc/nixos}"
  sudo nixos-rebuild switch --flake "$flake_path"
}

#──────────────────── Powerlevel10k Theme ────────────────────#
zinit ice depth=1; zinit light romkatv/powerlevel10k

# Load p10k config
for config in "${XDG_CONFIG_HOME:-$HOME/.config}/zsh/p10k.zsh" "$HOME/.dotfiles/config/zsh/p10k.zsh"; do
  [[ -f "$config" ]] && source "$config" && break
done

#──────────────────── Tmux Smart Auto-start ────────────────────#
# Only auto-start tmux in appropriate contexts
# Skip if: already in tmux, in VSCode terminal, in Alacritty, or in IDE terminal
if (( $+commands[tmux] )) && \
   [[ -z "$TMUX" ]] && \
   [[ -n "$PS1" ]] && \
   [[ ! "$TERM" =~ (screen|tmux) ]] && \
   [[ -z "$VSCODE_PID" ]] && \
   [[ -z "$TERM_PROGRAM" ]] && \
   [[ -z "$INTELLIJ_ENVIRONMENT_READER" ]]; then
  exec tmux new-session -A -s main
fi
